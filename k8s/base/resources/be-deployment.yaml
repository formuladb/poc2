apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: be
spec:
  replicas: 1
  strategy: {}
  template:
    metadata:
      labels:
        service: be
    spec:
      initContainers:
      - name: check-db-ready
        image: postgres:11
        command: ['sh', '-c', 
          'until pg_isready -h db -p 5432; 
          do echo waiting for database; sleep 2; done;']
      containers:
      - env:
        - name: DEBUG
          value: express:*
        - name: DEFAULT_USER
        - name: DEV_MODE
        - name: FRMDB_STORAGE
          value: postgres
        - name: PGHOST
          value: db
        - name: GITHOST
          value: git
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /etc/gcp/sa_credentials.json
        image: registry.gitlab.com/metawiz/febe/formuladb-be
        name: be
        ports:
        - containerPort: 3000
        - containerPort: 9231
        resources: {}
        volumeMounts:
        - name: service-account-credentials
          mountPath: /etc/gcp
          readOnly: true
        - mountPath: /wwwroot
          name: git-persistence
          subPath: gitroot
      volumes:
      - name: service-account-credentials
        secret:
          secretName: service-account-credentials
          items:
          - key: sa_json
            path: sa_credentials.json
      restartPolicy: Always
      imagePullSecrets:
        - name: regcred
status: {}
