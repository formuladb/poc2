@startuml formula_engine_architecture

!define ICONURL https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/v1.0.0
!includeurl ICONURL/font-awesome/database.puml
!includeurl ICONURL/font-awesome/long_arrow_right.puml

title __Formula Engine Architecture__\n\
A Transactional Stream Processing Engine

actor User

box "Formula DB Engine"
    participant "Transaction Controller\n<$database{scale=0.5}>db\n<$long_arrow_right{scale=0.5}>stream" as Trc
    participant "Object Owner\n<$database{scale=0.5}>db\n<$long_arrow_right{scale=0.5}>stream" as Obj
end box

note right User: synchronous REST communication for the User\n\
  even if FormulaDB works in an asynchronous manner internally

User --> Actions: MwzEvents{BaseObj}

note over Actions: partition by Action/Transaction _id\nan Action becomes a Transaction
note over Data: partition by BaseObj _id


Trc -> Trc: break down Transaction into Objects

note over Trc: BEGIN
Trc --> Obj: BEGIN: read objects
alt another "earlier" transaction is in progress on at least one object
  note over Obj: WAIT
  note over Obj: no reply sent to the Transaction Controller
else
  note over Obj: OK
  Trc <-- Obj: read objects OK+value-of-object
end
Trc -> Trc: compute new values based on received values

note over Trc: PRECOMMIT
Trc --> Obj: PRECOMMIT: write "redo log"
alt another "earlier" transaction is in progress on at least one object
  note over Obj: WAIT
  note over Obj: no reply sent to the Transaction Controller
  alt after "earlier" transaction finished
    note over Obj: OK
    Trc <-- Obj: read objects OK+value-of-object
    Trc -> Trc: compute again transaction with new values
    Trc --> Obj: PRECOMMIT again: write "redo log"
  end
else
  note over Obj: READY
  Trc <-- Obj: write objects to "redo log", READY + new value
end

alt all objects uodate return READY
  note over Trc: COMMIT
  Trc --> Obj: COMMIT: write objects
  note over Obj: DONE
  Trc <-- Obj: DONE
else at least one object returns FAIL
  note over Trc: ROLLBACK
  Trc --> Obj: ROLLBACK:discard "redo log"
  note over Obj: CANCEL
  Trc <-- Obj: CANCEL
end

@enduml
